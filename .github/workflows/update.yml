name: Build IPTV

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -------- Download hidden sources --------
      - name: Download playlists
        run: |
          curl -sL "${{ secrets.SRC1 }}" -o 1.m3u
          curl -sL "${{ secrets.SRC2 }}" -o 2.m3u
          curl -sL "${{ secrets.SRC3 }}" -o 3.m3u
          curl -sL "${{ secrets.SRC4 }}" -o 4.m3u
          curl -sL "${{ secrets.SRC5 }}" -o 5.m3u

      # -------- Rename SRC5 group to Z5 --------
      - name: Rename Zee5 group
        run: |
          sed -i 's/group-title="[^"]*"/group-title="Z5"/g' 5.m3u

      # -------- Build Kashmir.m3u --------
      - name: Build final playlist
        run: |
          echo "#EXTM3U" > Kashmir.m3u

          for f in 1.m3u 2.m3u 3.m3u 4.m3u 5.m3u; do
            sed '1{/^#EXTM3U/d}; s/\r$//; /^$/d' "$f" >> Kashmir.m3u
          done

      # -------- Remove duplicate clearkey lines --------
      - name: Clean duplicate clearkey tags
        run: |
          awk '
          {
            if ($0 == "#KODIPROP:inputstream.adaptive.license_type=clearkey") {
              if (prev == $0) next
            }
            print
            prev = $0
          }
          ' Kashmir.m3u > cleaned.m3u
          mv cleaned.m3u Kashmir.m3u

      # -------- Commit only if changed --------
      - name: Commit playlist
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Kashmir.m3u
          git diff --cached --quiet && exit 0
          git commit -m "Auto update Kashmir IPTV playlist"
          git push
