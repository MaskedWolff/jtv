name: Dual IPTV Build

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -------- Download hidden sources --------
      - name: Download playlists
        run: |
          curl -sL "${{ secrets.SRC1 }}" -o 1.m3u
          curl -sL "${{ secrets.SRC2 }}" -o 2.m3u
          curl -sL "${{ secrets.SRC3 }}" -o 3.m3u
          curl -sL "${{ secrets.SRC4 }}" -o 4.m3u

      # -------- Merge raw --------
      - name: Merge raw
        run: |
          echo "#EXTM3U" > all.m3u
          for f in 1.m3u 2.m3u 3.m3u 4.m3u; do
            sed '1{/^#EXTM3U/d}; s/\r$//; /^$/d' "$f" >> all.m3u
          done

      # -------- Build Tivimate-only (non-DRM HLS) --------
      - name: Build tivimate.m3u
        run: |
          echo "#EXTM3U" > tivimate.m3u
          awk '
          /#EXTINF/ {info=$0; getline url}
          url ~ /\.m3u8/ && info !~ /KODIPROP|license|cookie/ {
            print info
            print url
          }' all.m3u >> tivimate.m3u

      # -------- Build OTT full playlist --------
      - name: Build ott.m3u
        run: |
          cp all.m3u ott.m3u

      # -------- Commit only if changed --------
      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add tivimate.m3u ott.m3u
          git diff --cached --quiet && exit 0
          git commit -m "Auto update dual IPTV playlists"
          git push
