- name: Generate ztv.m3u
        run: |
          set -e
          URL="https://ztv.pfy.workers.dev"

          echo "Downloading JSON..."
          curl -L "$URL" -o data.json

          if [ ! -s data.json ]; then
            echo "JSON download failed"
            exit 1
          fi

          echo "#EXTM3U" > ztv.m3u

          jq -r '
            def normalize:
              if type=="array" then .
              elif type=="object" then
                if has("channels") then .channels
                elif has("data") then .data
                elif has("list") then .list
                else [.[]]
                end
              else [] end;

            normalize[]
            | select(type=="object")
            | (.name // .title // "Unknown") as $name
            | (.logo // "") as $logo
            | (.id // "") as $id
            | (.url // .link // .mpd // "") as $url
            | (.drmScheme // "") as $drm
            | (.drmLicense // "") as $lic
            | (.cookie // "") as $cookie
            | select($url != "")

            |
            "#EXTINF:-1 " +
            (if $id!="" then "tvg-id=\"" + $id + "\" " else "" end) +
            (if $logo!="" then "tvg-logo=\"" + $logo + "\" " else "" end) +
            "," + ($name | gsub(",";"\\,")),

            (if ($drm=="clearkey" and ($lic|contains(":")))
              then "#KODIPROP:inputstream.adaptive.license_type=clearkey",
                   "#KODIPROP:inputstream.adaptive.license_key=" + $lic
              else empty end),

            (if $cookie!=""
              then "#EXTHTTP:{\"cookie\":\"" + ($cookie|gsub("\"";"\\\"")) + "\"}"
              else empty end),

            $url
          ' data.json >> ztv.m3u

          echo "Clean playlist lines:"
          wc -l ztv.m3u
